{% extends 'base.html' %}
{% block title %}åˆ›å»ºæ–°ä»»åŠ¡ - Trustee{% endblock %}

{% block extra_head %}
<style>
    .create-task-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .task-form-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .form-section {
        margin-bottom: 25px;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #2196F3;
    }
    
    .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 100px;
        transition: border-color 0.3s ease;
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: #2196F3;
    }
    
    .device-selection {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 10px;
    }
    
    .device-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .device-card.selected {
        border-color: #2196F3;
        background: #f3f8ff;
    }
    
    .device-card:hover {
        border-color: #2196F3;
    }
    
    .device-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    
    .device-info {
        font-size: 12px;
        color: #666;
    }
    
    .status-online {
        color: #4CAF50;
    }
    
    .status-offline {
        color: #f44336;
    }
    
    .ai-analysis-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
    }
    
    .ai-section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
    }
    
    .screenshot-preview {
        max-width: 300px;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        margin: 15px 0;
    }
    
    .ai-steps-container {
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }
    
    .step-item {
        background: rgba(255,255,255,0.15);
        border-radius: 6px;
        padding: 12px;
        margin: 10px 0;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    
    .step-number {
        background: rgba(255,255,255,0.3);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        flex-shrink: 0;
    }
    
    .step-description {
        flex: 1;
        font-size: 14px;
        line-height: 1.4;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }
    
    .btn-secondary {
        background: #9E9E9E;
        color: white;
    }
    
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .loading-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        max-width: 400px;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e0e0e0;
        border-top: 4px solid #2196F3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .success-message {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        display: none;
    }
    
    .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="create-task-container">
    <div class="page-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="/tasks" style="color: #666; text-decoration: none;">
                <i class="material-icons">arrow_back</i>
            </a>
            <div>
                <h1><i class="material-icons">add_task</i> åˆ›å»ºæ–°ä»»åŠ¡</h1>
                <p>è¾“å…¥ä»»åŠ¡æè¿°ï¼ŒAIä¼šè‡ªåŠ¨åˆ†æå±å¹•å¹¶ç”Ÿæˆæ‰§è¡Œæ­¥éª¤</p>
            </div>
        </div>
    </div>

    <div class="task-form-card">
        <form id="createTaskForm">
            <div class="form-section">
                <label class="form-label" for="taskName">
                    <i class="material-icons" style="vertical-align: middle; margin-right: 5px;">title</i>
                    ä»»åŠ¡åç§°
                </label>
                <input type="text" id="taskName" class="form-input" placeholder="ä¾‹å¦‚ï¼šç™»å½•ç³»ç»Ÿã€å‘é€é‚®ä»¶ã€æ•°æ®å¯¼å‡ºç­‰" required>
            </div>

            <div class="form-section">
                <label class="form-label" for="taskDescription">
                    <i class="material-icons" style="vertical-align: middle; margin-right: 5px;">description</i>
                    è¯¦ç»†æè¿° (å‘Šè¯‰AIä½ æƒ³åšä»€ä¹ˆ)
                </label>
                <textarea id="taskDescription" class="form-textarea" placeholder="è¯·è¯¦ç»†æè¿°ä½ æƒ³è¦è‡ªåŠ¨åŒ–çš„æ“ä½œï¼Œä¾‹å¦‚ï¼š&#10;â€¢ ç‚¹å‡»ç™»å½•æŒ‰é’®ï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç &#10;â€¢ åœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…³é”®è¯å¹¶ç‚¹å‡»æœç´¢&#10;â€¢ ä¸‹è½½é¡µé¢ä¸­çš„æ–‡ä»¶&#10;AIä¼šæ ¹æ®å½“å‰å±å¹•æˆªå›¾åˆ†æå¹¶ç”Ÿæˆå…·ä½“çš„æ‰§è¡Œæ­¥éª¤" required></textarea>
            </div>

            <div class="form-section">
                <label class="form-label">
                    <i class="material-icons" style="vertical-align: middle; margin-right: 5px;">devices</i>
                    é€‰æ‹©æ‰§è¡Œè®¾å¤‡
                </label>
                <div id="deviceSelection" class="device-selection">
                    <div class="loading" style="text-align: center; padding: 20px; color: #666;">
                        æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="ai-analysis-section" id="aiAnalysisSection" style="display: none;">
        <div class="ai-section-title">
            <i class="material-icons">psychology</i>
            <span>AIåˆ†æç»“æœ</span>
        </div>
        
        <div id="screenshotContainer" style="text-align: center;">
            <p><i class="material-icons">camera_alt</i> å½“å‰å±å¹•æˆªå›¾</p>
            <img id="screenshotPreview" class="screenshot-preview" alt="å±å¹•æˆªå›¾">
        </div>
        
        <div class="ai-steps-container">
            <h4 style="margin: 0 0 15px 0;"><i class="material-icons">list</i> ç”Ÿæˆçš„æ‰§è¡Œæ­¥éª¤</h4>
            <div id="stepsContainer">
                <!-- æ­¥éª¤å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div id="multiRoundDetails" class="multi-round-details" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin: 15px 0; display: none;">
            <h4 style="margin: 0 0 15px 0;"><i class="material-icons">psychology</i> è¯¦ç»†æ€è€ƒè¿‡ç¨‹</h4>
            <div id="roundsContainer">
                <!-- å¤šè½®æ€è€ƒè¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        
        <div id="codePreview" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; margin: 15px 0; font-family: monospace; font-size: 12px; line-height: 1.4; white-space: pre-wrap; display: none;">
            <!-- AIç”Ÿæˆçš„ä»£ç å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
    </div>

    <div class="success-message" id="successMessage">
        <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">check_circle</i>
        <span id="successText"></span>
    </div>

    <div class="error-message" id="errorMessage">
        <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">error</i>
        <span id="errorText"></span>
    </div>

    <div class="action-buttons">
        <button type="button" class="btn btn-primary" onclick="startAIAnalysis()">
            <i class="material-icons">psychology</i>
            å¼€å§‹AIåˆ†æ
        </button>
        
        <button type="button" class="btn btn-success" onclick="createTask()" id="createTaskBtn" style="display: none;">
            <i class="material-icons">save</i>
            åˆ›å»ºä»»åŠ¡
        </button>
        
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/tasks'">
            <i class="material-icons">cancel</i>
            å–æ¶ˆ
        </button>
    </div>
</div>

<!-- åŠ è½½è¦†ç›–å±‚ -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h3 id="loadingTitle">æ­£åœ¨åˆ†æ...</h3>
        <p id="loadingMessage">AIæ­£åœ¨åˆ†ææ‚¨çš„å±å¹•å¹¶ç”Ÿæˆæ‰§è¡Œæ­¥éª¤ï¼Œè¯·ç¨å€™...</p>
    </div>
</div>

<script>
let currentAnalysisResult = null;
let selectedDeviceId = null;
let availableDevices = [];

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadDevices();
});

// åŠ è½½è®¾å¤‡åˆ—è¡¨
async function loadDevices() {
    try {
        const response = await fetch('/api/devices');
        const result = await response.json();
        
        if (result.success) {
            availableDevices = result.devices;
            renderDevices();
        } else {
            showError('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½è®¾å¤‡é”™è¯¯:', error);
        showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è®¾å¤‡åˆ—è¡¨');
    }
}

// æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
function renderDevices() {
    const container = document.getElementById('deviceSelection');
    
    if (availableDevices.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
                <i class="material-icons" style="font-size: 48px; margin-bottom: 10px;">devices_off</i>
                <p>æš‚æ— å¯ç”¨è®¾å¤‡</p>
                <a href="/devices" style="color: #2196F3;">å»æ·»åŠ è®¾å¤‡</a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = availableDevices.map(device => `
        <div class="device-card" onclick="selectDevice(${device.device_id})" data-device-id="${device.device_id}">
            <div class="device-name">${device.device_name}</div>
            <div class="device-info">
                <span class="status-${device.status}">${device.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}</span>
                <br>
                ${device.device_ip || 'æœ¬åœ°è®¾å¤‡'}
            </div>
        </div>
    `).join('');
    
    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªåœ¨çº¿è®¾å¤‡
    const onlineDevice = availableDevices.find(d => d.status === 'online');
    if (onlineDevice) {
        selectDevice(onlineDevice.device_id);
    }
}

// é€‰æ‹©è®¾å¤‡
function selectDevice(deviceId) {
    selectedDeviceId = deviceId;
    
    // æ›´æ–°è§†è§‰çŠ¶æ€
    document.querySelectorAll('.device-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    const selectedCard = document.querySelector(`[data-device-id="${deviceId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }
}

// å¼€å§‹AIåˆ†æ
async function startAIAnalysis() {
    const taskName = document.getElementById('taskName').value.trim();
    const taskDescription = document.getElementById('taskDescription').value.trim();
    
    if (!taskName) {
        showError('è¯·è¾“å…¥ä»»åŠ¡åç§°');
        return;
    }
    
    if (!taskDescription) {
        showError('è¯·è¾“å…¥ä»»åŠ¡æè¿°');
        return;
    }
    
    if (!selectedDeviceId) {
        showError('è¯·é€‰æ‹©æ‰§è¡Œè®¾å¤‡');
        return;
    }
    
    showLoading('æ­£åœ¨æˆªå›¾...', 'æ­£åœ¨æ•è·å½“å‰å±å¹•ï¼Œè¯·ä¿æŒç•Œé¢çŠ¶æ€...');
    
    try {
        // ç¬¬1æ­¥ï¼šè‡ªåŠ¨æˆªå›¾
        const screenshotResponse = await fetch('/api/screenshot/capture', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ delay: 1000 })
        });
        
        const screenshotResult = await screenshotResponse.json();
        
        if (!screenshotResult.success) {
            throw new Error('æˆªå›¾å¤±è´¥: ' + screenshotResult.message);
        }
        
        // ç¬¬2æ­¥ï¼šå¤šè½®AIåˆ†æå’Œæ€è€ƒ
        const finalAnalysisResult = await performMultiRoundAnalysis(screenshotResult, taskDescription);
        
        // ä¿å­˜åˆ†æç»“æœ
        currentAnalysisResult = finalAnalysisResult;
        
        // æ˜¾ç¤ºåˆ†æç»“æœ
        displayAnalysisResult(finalAnalysisResult, screenshotResult.screenshot_url);
        
        hideLoading();
        showSuccess('AIå¤šè½®åˆ†æå®Œæˆï¼å·²ç”Ÿæˆè¯¦ç»†æ‰§è¡Œæ­¥éª¤');
        
    } catch (error) {
        console.error('AIåˆ†æé”™è¯¯:', error);
        hideLoading();
        showError('AIåˆ†æå¤±è´¥: ' + error.message);
    }
}

// æ‰§è¡Œå¤šè½®AIåˆ†æ
async function performMultiRoundAnalysis(screenshotResult, taskDescription) {
    const screenshotBlob = await fetch(screenshotResult.screenshot_url).then(r => r.blob());
    const analysisRounds = [];
    let cumulativeThoughts = [];
    
    // ç¬¬1è½®ï¼šåˆæ­¥åˆ†æ
    updateLoading('AIç¬¬1è½®åˆ†æ...', 'æ­£åœ¨è¿›è¡Œåˆæ­¥å±å¹•ç†è§£å’Œä»»åŠ¡åˆ†è§£...');
    const round1Result = await callAIAnalysis(screenshotBlob, screenshotResult.filename, 
        `è¯·ä»”ç»†è§‚å¯Ÿè¿™ä¸ªå±å¹•æˆªå›¾ï¼Œæˆ‘æƒ³è¦æ‰§è¡Œçš„ä»»åŠ¡æ˜¯ï¼š${taskDescription}ã€‚
        
        è¯·ä½ å…ˆè¿›è¡Œåˆæ­¥åˆ†æï¼š
        1. æè¿°ä½ åœ¨å±å¹•ä¸Šçœ‹åˆ°äº†ä»€ä¹ˆç•Œé¢å…ƒç´ 
        2. åˆ†æè¦å®Œæˆè¿™ä¸ªä»»åŠ¡å¯èƒ½éœ€è¦å“ªäº›æ­¥éª¤
        3. è¯†åˆ«å…³é”®çš„äº¤äº’å…ƒç´ ï¼ˆæŒ‰é’®ã€è¾“å…¥æ¡†ã€é“¾æ¥ç­‰ï¼‰
        4. æå‡ºä½ çš„åˆæ­¥æ‰§è¡Œæ–¹æ¡ˆ
        
        è¿™æ˜¯ç¬¬1è½®åˆ†æï¼Œè¯·è¯¦ç»†æ€è€ƒã€‚`);
    
    if (round1Result.success) {
        analysisRounds.push({
            round: 1,
            purpose: 'åˆæ­¥åˆ†æ',
            result: round1Result
        });
        cumulativeThoughts.push(round1Result.parsed_action?.thought || '');
    }
    
    // ç¬¬2è½®ï¼šæ·±åº¦åˆ†æå’Œä¼˜åŒ–
    updateLoading('AIç¬¬2è½®åˆ†æ...', 'æ­£åœ¨è¿›è¡Œæ·±åº¦åˆ†æå’Œæ–¹æ¡ˆä¼˜åŒ–...');
    const round2Result = await callAIAnalysis(screenshotBlob, screenshotResult.filename,
        `åŸºäºç¬¬1è½®åˆ†æçš„ç»“æœï¼Œç°åœ¨è¿›è¡Œç¬¬2è½®æ·±åº¦åˆ†æã€‚
        
        ç¬¬1è½®çš„æ€è€ƒç»“æœï¼š${cumulativeThoughts.join(' ')}
        
        ä»»åŠ¡ç›®æ ‡ï¼š${taskDescription}
        
        è¯·åœ¨ç¬¬1è½®åˆ†æåŸºç¡€ä¸Šï¼š
        1. éªŒè¯å’Œä¼˜åŒ–æ‰§è¡Œæ–¹æ¡ˆ
        2. è€ƒè™‘å¯èƒ½çš„å¼‚å¸¸æƒ…å†µå’Œå¤‡é€‰æ–¹æ¡ˆ
        3. ç»†åŒ–æ¯ä¸ªæ­¥éª¤çš„å…·ä½“æ“ä½œ
        4. ç¡®è®¤åæ ‡å®šä½çš„å‡†ç¡®æ€§
        5. è¯„ä¼°æ‰§è¡ŒæˆåŠŸçš„å¯èƒ½æ€§
        
        è¯·ç»™å‡ºæ›´åŠ ç²¾ç¡®å’Œå¯é çš„æ‰§è¡Œæ–¹æ¡ˆã€‚`);
    
    if (round2Result.success) {
        analysisRounds.push({
            round: 2,
            purpose: 'æ·±åº¦åˆ†æ',
            result: round2Result
        });
        cumulativeThoughts.push(round2Result.parsed_action?.thought || '');
    }
    
    // ç¬¬3è½®ï¼šæœ€ç»ˆç¡®è®¤å’Œä»£ç ç”Ÿæˆ
    updateLoading('AIç¬¬3è½®åˆ†æ...', 'æ­£åœ¨è¿›è¡Œæœ€ç»ˆç¡®è®¤å’Œä»£ç ç”Ÿæˆ...');
    const round3Result = await callAIAnalysis(screenshotBlob, screenshotResult.filename,
        `è¿™æ˜¯æœ€ç»ˆçš„ç¬¬3è½®åˆ†æã€‚è¯·ç»¼åˆå‰ä¸¤è½®çš„åˆ†æç»“æœï¼š
        
        ç¬¬1è½®åˆ†æï¼š${analysisRounds[0]?.result?.parsed_action?.thought || ''}
        ç¬¬2è½®åˆ†æï¼š${analysisRounds[1]?.result?.parsed_action?.thought || ''}
        
        ä»»åŠ¡ç›®æ ‡ï¼š${taskDescription}
        
        ç°åœ¨è¯·ï¼š
        1. ç»¼åˆå‰ä¸¤è½®çš„åˆ†æï¼Œç¡®å®šæœ€ä¼˜æ‰§è¡Œæ–¹æ¡ˆ
        2. ç”Ÿæˆç²¾ç¡®çš„PyAutoGUIä»£ç 
        3. ç¡®ä¿åæ ‡å®šä½å‡†ç¡®
        4. æ·»åŠ å¿…è¦çš„ç­‰å¾…å’ŒéªŒè¯æœºåˆ¶
        5. æä¾›æ¸…æ™°çš„æ­¥éª¤è¯´æ˜
        
        è¿™æ˜¯æœ€ç»ˆç‰ˆæœ¬ï¼Œè¯·ç¡®ä¿ä»£ç çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚`);
    
    if (round3Result.success) {
        analysisRounds.push({
            round: 3,
            purpose: 'æœ€ç»ˆç¡®è®¤',
            result: round3Result
        });
        cumulativeThoughts.push(round3Result.parsed_action?.thought || '');
    }
    
    // æ•´åˆæ‰€æœ‰è½®æ¬¡çš„åˆ†æç»“æœ
    const finalResult = round3Result.success ? round3Result : 
                       (round2Result.success ? round2Result : round1Result);
    
    // å¢å¼ºæœ€ç»ˆç»“æœï¼ŒåŒ…å«å¤šè½®æ€è€ƒè¿‡ç¨‹
    if (finalResult.success) {
        finalResult.multi_round_analysis = {
            total_rounds: analysisRounds.length,
            rounds: analysisRounds,
            cumulative_thoughts: cumulativeThoughts,
            final_confidence: calculateConfidence(analysisRounds)
        };
        
        // å¢å¼ºæ€è€ƒè¿‡ç¨‹æè¿°
        if (finalResult.parsed_action) {
            finalResult.parsed_action.detailed_thought = cumulativeThoughts.join('\n\n--- ä¸‹ä¸€è½®æ€è€ƒ ---\n\n');
        }
    }
    
    return finalResult;
}

// è°ƒç”¨å•æ¬¡AIåˆ†æ
async function callAIAnalysis(screenshotBlob, filename, instruction) {
    const formData = new FormData();
    formData.append('screenshot', screenshotBlob, filename);
    formData.append('instruction', instruction);
    formData.append('target_resolution', 'auto');
    
    const response = await fetch('/api/ai/analyze', {
        method: 'POST',
        body: formData
    });
    
    return await response.json();
}

// è®¡ç®—ç»¼åˆç½®ä¿¡åº¦
function calculateConfidence(rounds) {
    if (rounds.length === 0) return 0.5;
    
    const confidences = rounds.map(r => r.result?.confidence_score || 0.5);
    const avgConfidence = confidences.reduce((a, b) => a + b, 0) / confidences.length;
    
    // å¤šè½®åˆ†æä¼šæé«˜ç½®ä¿¡åº¦
    const roundBonus = Math.min(0.2, rounds.length * 0.05);
    
    return Math.min(1.0, avgConfidence + roundBonus);
}

// æ˜¾ç¤ºå¤šè½®æ€è€ƒè¯¦æƒ…
function displayMultiRoundDetails(multiRoundAnalysis) {
    const detailsSection = document.getElementById('multiRoundDetails');
    const roundsContainer = document.getElementById('roundsContainer');
    
    if (!detailsSection || !roundsContainer) return;
    
    // ç”Ÿæˆæ¯è½®åˆ†æçš„è¯¦ç»†å±•ç¤º
    roundsContainer.innerHTML = multiRoundAnalysis.rounds.map((round, index) => {
        const action = round.result?.parsed_action || {};
        const confidence = round.result?.confidence_score || 0;
        
        return `
            <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 15px; margin: 10px 0; border-left: 4px solid ${getRoundColor(round.round)};">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div style="background: ${getRoundColor(round.round)}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        ${round.round}
                    </div>
                    <div>
                        <h5 style="margin: 0; color: white;">${round.purpose}</h5>
                        <small style="color: rgba(255,255,255,0.7);">ç½®ä¿¡åº¦: ${Math.round(confidence * 100)}%</small>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 4px; padding: 12px; margin: 10px 0;">
                    <strong style="color: white;">AIæ€è€ƒè¿‡ç¨‹:</strong>
                    <p style="margin: 8px 0 0 0; color: rgba(255,255,255,0.9); line-height: 1.5; font-size: 13px;">
                        ${action.thought || 'æ— è¯¦ç»†æ€è€ƒè®°å½•'}
                    </p>
                </div>
                
                ${action.action ? `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 4px; padding: 10px; margin: 10px 0;">
                        <strong style="color: white;">è¯†åˆ«æ“ä½œ:</strong>
                        <div style="margin-top: 5px; color: rgba(255,255,255,0.9); font-size: 13px;">
                            <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; margin-right: 8px;">
                                ${getActionIcon(action.action)} ${getActionName(action.action)}
                            </span>
                            ${action.content ? `<span style="color: rgba(255,255,255,0.7);">å†…å®¹: "${action.content}"</span>` : ''}
                            ${action.start_box ? `<span style="color: rgba(255,255,255,0.7);">åæ ‡: (${action.start_box[0]}, ${action.start_box[1]})</span>` : ''}
                        </div>
                    </div>
                ` : ''}
                
                ${round.result?.pyautogui_code && round.result.pyautogui_code !== '# æ— å¯æ‰§è¡Œçš„æ“ä½œ' ? `
                    <details style="margin-top: 10px;">
                        <summary style="color: white; cursor: pointer; font-size: 13px;">æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç </summary>
                        <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin: 5px 0; color: rgba(255,255,255,0.8); font-size: 11px; line-height: 1.4; overflow-x: auto;">${round.result.pyautogui_code}</pre>
                    </details>
                ` : ''}
            </div>
        `;
    }).join('');
    
    // æ·»åŠ ç»¼åˆåˆ†ææ‘˜è¦
    roundsContainer.innerHTML += `
        <div style="background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%); border-radius: 8px; padding: 20px; margin: 20px 0; border: 2px solid rgba(255,255,255,0.2);">
            <h5 style="margin: 0 0 15px 0; color: white; display: flex; align-items: center; gap: 8px;">
                <i class="material-icons">analytics</i>
                ç»¼åˆåˆ†ææ‘˜è¦
            </h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${multiRoundAnalysis.total_rounds}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">åˆ†æè½®æ•°</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${Math.round(multiRoundAnalysis.final_confidence * 100)}%</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">ç»¼åˆç½®ä¿¡åº¦</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${multiRoundAnalysis.cumulative_thoughts.length}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">æ€è€ƒè®°å½•</div>
                </div>
            </div>
        </div>
    `;
    
    // æ˜¾ç¤ºè¯¦æƒ…åŒºåŸŸ
    detailsSection.style.display = 'block';
}

// è·å–è½®æ¬¡é¢œè‰²
function getRoundColor(round) {
    const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'];
    return colors[(round - 1) % colors.length];
}

// è·å–æ“ä½œå›¾æ ‡
function getActionIcon(action) {
    const icons = {
        'click': 'ğŸ–±ï¸',
        'type': 'âŒ¨ï¸',
        'scroll': 'ğŸ“œ',
        'key': 'ğŸ”‘',
        'wait': 'â±ï¸'
    };
    return icons[action] || 'ğŸ¤–';
}

// è·å–æ“ä½œåç§°
function getActionName(action) {
    const names = {
        'click': 'ç‚¹å‡»',
        'type': 'è¾“å…¥',
        'scroll': 'æ»šåŠ¨',
        'key': 'æŒ‰é”®',
        'wait': 'ç­‰å¾…'
    };
    return names[action] || 'æœªçŸ¥æ“ä½œ';
}

// æ˜¾ç¤ºåˆ†æç»“æœ
function displayAnalysisResult(result, screenshotUrl) {
    const section = document.getElementById('aiAnalysisSection');
    const preview = document.getElementById('screenshotPreview');
    const stepsContainer = document.getElementById('stepsContainer');
    const codePreview = document.getElementById('codePreview');
    const createBtn = document.getElementById('createTaskBtn');
    
    // æ˜¾ç¤ºæˆªå›¾
    preview.src = screenshotUrl;
    
    // ç”Ÿæˆæ­¥éª¤åˆ—è¡¨
    const steps = generateStepsFromAnalysis(result);
    stepsContainer.innerHTML = steps.map((step, index) => `
        <div class="step-item">
            <div class="step-number">${index + 1}</div>
            <div class="step-description">${step}</div>
        </div>
    `).join('');
    
    // æ˜¾ç¤ºä»£ç é¢„è§ˆï¼ˆå¯é€‰ï¼‰
    if (result.pyautogui_code) {
        codePreview.textContent = result.pyautogui_code;
        codePreview.style.display = 'block';
    }
    
    // æ˜¾ç¤ºå¤šè½®æ€è€ƒè¯¦æƒ…
    if (result.multi_round_analysis) {
        displayMultiRoundDetails(result.multi_round_analysis);
    }
    
    // æ˜¾ç¤ºåˆ†æç»“æœåŒºåŸŸå’Œåˆ›å»ºæŒ‰é’®
    section.style.display = 'block';
    createBtn.style.display = 'inline-flex';
    
    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    section.scrollIntoView({ behavior: 'smooth' });
}

// ä»AIåˆ†æç»“æœç”Ÿæˆæ­¥éª¤æè¿°
function generateStepsFromAnalysis(result) {
    const steps = [];
    const action = result.parsed_action;
    
    // å¦‚æœæœ‰å¤šè½®åˆ†æç»“æœï¼Œæ˜¾ç¤ºè¯¦ç»†çš„æ€è€ƒè¿‡ç¨‹
    if (result.multi_round_analysis) {
        const analysis = result.multi_round_analysis;
        
        steps.push(`ğŸ§  AIå¤šè½®æ€è€ƒ (å…±${analysis.total_rounds}è½®åˆ†æ)`);
        steps.push(`ğŸ“Š ç»¼åˆç½®ä¿¡åº¦: ${Math.round(analysis.final_confidence * 100)}%`);
        
        // æ˜¾ç¤ºæ¯è½®åˆ†æçš„è¦ç‚¹
        analysis.rounds.forEach((round, index) => {
            const roundAction = round.result?.parsed_action;
            if (roundAction?.thought) {
                steps.push(`ğŸ’­ ç¬¬${round.round}è½® (${round.purpose}): ${roundAction.thought.substring(0, 100)}${roundAction.thought.length > 100 ? '...' : ''}`);
            }
        });
        
        steps.push('--- æœ€ç»ˆæ‰§è¡Œæ–¹æ¡ˆ ---');
    } else {
        // å•è½®åˆ†æçš„æ€è€ƒè¿‡ç¨‹
        if (action.thought) {
            steps.push(`ğŸ’­ AIåˆ†ææ€è·¯: ${action.thought}`);
        }
    }
    
    // æ ¹æ®æ“ä½œç±»å‹ç”Ÿæˆæè¿°
    if (action.action === 'click') {
        const coords = action.start_box;
        steps.push(`ğŸ–±ï¸ ç‚¹å‡»æ“ä½œ: åœ¨åæ ‡ (${coords[0]}, ${coords[1]}) ä½ç½®æ‰§è¡Œé¼ æ ‡ç‚¹å‡»`);
    } else if (action.action === 'type') {
        steps.push(`âŒ¨ï¸ è¾“å…¥æ“ä½œ: è¾“å…¥æ–‡æœ¬å†…å®¹ "${action.content}"`);
        if (action.start_box) {
            const coords = action.start_box;
            steps.push(`ğŸ“ è¾“å…¥ä½ç½®: åœ¨åæ ‡ (${coords[0]}, ${coords[1]}) çš„è¾“å…¥æ¡†ä¸­`);
        }
    } else if (action.action === 'scroll') {
        steps.push('ğŸ–±ï¸ æ»šåŠ¨æ“ä½œ: åœ¨å½“å‰é¡µé¢æ‰§è¡Œæ»šåŠ¨æ“ä½œ');
    } else if (action.action === 'key') {
        steps.push(`âŒ¨ï¸ æŒ‰é”®æ“ä½œ: æŒ‰ä¸‹ ${action.content} é”®`);
    }
    
    // æ·»åŠ æ‰§è¡Œä»£ç è¯´æ˜
    if (result.pyautogui_code && result.pyautogui_code !== '# æ— å¯æ‰§è¡Œçš„æ“ä½œ') {
        steps.push('âš™ï¸ ä»£ç æ‰§è¡Œ: ä½¿ç”¨PyAutoGUIåº“æ‰§è¡Œè‡ªåŠ¨åŒ–æ“ä½œ');
        steps.push('ğŸ“ åæ ‡é€‚é…: æ ¹æ®ç›®æ ‡è®¾å¤‡åˆ†è¾¨ç‡è‡ªåŠ¨è°ƒæ•´åæ ‡ä½ç½®');
    }
    
    // å¦‚æœæ²¡æœ‰å…·ä½“æ­¥éª¤ï¼Œæ·»åŠ é»˜è®¤æè¿°
    if (steps.length === 0) {
        steps.push('ğŸ¤– AIå°†æ ¹æ®æˆªå›¾å†…å®¹æ‰§è¡Œç›¸åº”çš„è‡ªåŠ¨åŒ–æ“ä½œ');
    }
    
    return steps;
}

// åˆ›å»ºä»»åŠ¡
async function createTask() {
    if (!currentAnalysisResult) {
        showError('è¯·å…ˆå®ŒæˆAIåˆ†æ');
        return;
    }
    
    const taskName = document.getElementById('taskName').value.trim();
    const taskDescription = document.getElementById('taskDescription').value.trim();
    
    showLoading('æ­£åœ¨åˆ›å»ºä»»åŠ¡...', 'æ­£åœ¨ä¿å­˜ä»»åŠ¡å’ŒAIåˆ†æç»“æœ...');
    
    try {
        const taskData = {
            task_name: taskName,
            natural_language_input: taskDescription,
            device_id: selectedDeviceId,
            ai_analysis: currentAnalysisResult,
            task_type: 'ai_automation'
        };
        
        const response = await fetch('/api/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(taskData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            hideLoading();
            showSuccess('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼å³å°†è·³è½¬åˆ°ä»»åŠ¡åˆ—è¡¨...');
            
            setTimeout(() => {
                window.location.href = '/tasks';
            }, 2000);
        } else {
            throw new Error(result.message || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
        }
        
    } catch (error) {
        console.error('åˆ›å»ºä»»åŠ¡é”™è¯¯:', error);
        hideLoading();
        showError('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + error.message);
    }
}

// å·¥å…·å‡½æ•°
function showLoading(title, message) {
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function updateLoading(title, message) {
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function showSuccess(message) {
    const element = document.getElementById('successMessage');
    document.getElementById('successText').textContent = message;
    element.style.display = 'block';
    
    setTimeout(() => {
        element.style.display = 'none';
    }, 5000);
}

function showError(message) {
    const element = document.getElementById('errorMessage');
    document.getElementById('errorText').textContent = message;
    element.style.display = 'block';
    
    setTimeout(() => {
        element.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %} 